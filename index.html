<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PD Parameter Database</title>

  <!-- DataTables core + extensions -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script><!-- Column show/hide -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#0b1220;
      --card: rgba(255,255,255,0.92);
      --stroke: rgba(255,255,255,0.20);
      --text:#0b1220;
      --muted: rgba(11,18,32,0.65);
      --shadow: 0 18px 45px rgba(0,0,0,0.25);
      --r: 18px;
      --p: #7c3aed;
      --c: #06b6d4;
      --g: #22c55e;
      --o: #f59e0b;
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1100px 600px at 10% 10%, rgba(124,58,237,0.35), transparent 55%),
        radial-gradient(900px 500px at 90% 15%, rgba(6,182,212,0.28), transparent 55%),
        radial-gradient(900px 500px at 50% 95%, rgba(34,197,94,0.20), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color: white;
    }
    .wrap{ max-width: 1240px; margin: 0 auto; padding: 26px 16px 46px; }

    .hero{
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      background: linear-gradient(135deg, rgba(255,255,255,0.13), rgba(255,255,255,0.06));
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
    }
    .topline{ display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width: 42px; height: 42px; border-radius: 14px;
      background: linear-gradient(135deg, var(--p), var(--c));
      box-shadow: 0 10px 28px rgba(124,58,237,0.25);
    }
    h1{ margin:0; font-size: 18px; letter-spacing: .2px; }
    .sub{ margin:6px 0 0; color: rgba(255,255,255,0.78); font-size: 13px; line-height: 1.35; }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.10);
      font-size: 12px;
      white-space: nowrap;
    }
    .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--g);
      box-shadow: 0 0 0 4px rgba(34,197,94,0.18);
    }

    .controls{
      margin-top: 14px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      padding: 14px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 980px){
      .controls{ grid-template-columns: 1fr 1fr 1fr 1fr; align-items:end; }
      .controls .wide{ grid-column: span 4; }
    }
    label{
      display:block; font-size: 12px;
      color: rgba(255,255,255,0.86);
      margin-bottom: 6px;
    }
    .field input, .field button{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.10);
      color: white;
      outline: none;
      font-size: 13px;
    }
    .field input::placeholder{ color: rgba(255,255,255,0.70); }
    .field button{
      cursor:pointer;
      border: none;
      font-weight: 800;
      letter-spacing: .2px;
      background: linear-gradient(135deg, var(--o), var(--p));
      box-shadow: 0 12px 30px rgba(245,158,11,0.18);
    }

    .card{
      margin-top: 14px;
      border-radius: var(--r);
      background: var(--card);
      color: var(--text);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.16);
      overflow: hidden;
    }
    .pad{ padding: 12px 12px 6px; }

    table.dataTable{ width:100% !important; }
    table.dataTable thead th{
      white-space: nowrap;
      background: linear-gradient(135deg, rgba(124,58,237,0.14), rgba(6,182,212,0.10));
      border-bottom: 1px solid rgba(0,0,0,0.08) !important;
      color: #0b1220;
    }

    /* Filter row */
    #tbl thead tr.filters th{
      background: rgba(255,255,255,0.98);
      padding: 8px 10px !important;
      border-bottom: 1px solid rgba(0,0,0,0.08) !important;
      vertical-align: top;
    }
    .colFilter{
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 140px;
    }
    .colFilter input,
    .colFilter select{
      width: 100%;
      box-sizing: border-box;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.14);
      font-size: 12px;
      outline: none;
      background: #fff;
      color: #0b1220;
    }

    /* Buttons + global search */
    .dataTables_wrapper .dataTables_filter input{
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      padding: 7px 10px;
      outline: none;
    }
    .dt-buttons .dt-button{
      border-radius: 999px !important;
      border: 1px solid rgba(0,0,0,0.12) !important;
      background: linear-gradient(135deg, rgba(124,58,237,0.10), rgba(6,182,212,0.10)) !important;
      padding: 7px 12px !important;
      font-size: 12px !important;
      color: #0b1220 !important;
    }

    a{ color: #4f46e5; text-decoration: none; font-weight: 650; }
    a:hover{ text-decoration: underline; }

    table.dataTable tbody tr:hover{
      background: rgba(6,182,212,0.08) !important;
    }

    .miniHint{ margin-top: 10px; font-size: 12px; color: rgba(11,18,32,0.65); }

    /* Row details */
    td.details-control{
      cursor: pointer;
      white-space: nowrap;
      font-weight: 900;
      color: #4f46e5;
    }
    tr.shown td.details-control{
      color: #0ea5e9;
    }
    .detailsBox{
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(79,70,229,0.06);
      border: 1px solid rgba(0,0,0,0.08);
      line-height: 1.4;
      font-size: 13px;
      color: #0b1220;
    }
    .detailsBox .k{
      font-weight: 800;
      margin-right: 6px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="hero">
    <div class="topline">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Pharmacodynamic Parameter Database</h1>
          <div class="sub">Search by Title, filter per column, and click a row to view the full reference (Citation).</div>
        </div>
      </div>
      <div class="badge"><span class="dot"></span><span id="rowCount">0 rows</span></div>
    </div>

    <div class="controls">
      <div class="field">
        <label>Search article by Title (global)</label>
        <input id="titleGlobal" type="text" placeholder="Type part of the title…">
      </div>

      <div class="field">
        <label>Search by PMC ID (global)</label>
        <input id="pmcGlobal" type="text" placeholder="PMC10060419">
      </div>

      <div class="field">
        <label>Search by Parameter (global)</label>
        <input id="paramGlobal" type="text" placeholder="MIC, EC50, ...">
      </div>

      <div class="field">
        <label>Search by Drug/compound (global)</label>
        <input id="drugGlobal" type="text" placeholder="Zinc Oxide...">
      </div>

      <div class="field wide">
        <button id="clearAll">Clear all filters</button>
        <div class="miniHint">
          Per-column filters are in the header row. For selected columns you also get a dropdown of unique values.
          Click “+” at the start of a row to view the Citation/reference.
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="pad">
      <table id="tbl" class="display nowrap" style="width:100%">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script>
(function () {
  // CSV headers (must match exactly)
  const H = {
    pmc: "PMC ID",
    parameter: "Parameter",
    value: "Reported numerical value",
    unit: "Unit",
    species: "Bacterial species name",
    strain: "Bacterial strain(s)",
    source: "Source of isolates",
    status: "Wild-type or mutant status",
    mode: "Biofilm / planktonic / mixed",
    drug: "Drug or chemical compound name(s)",
    drugDose: "Drug amount/concentration with unit and time",
    evidence: "Evidence - First Sentence of paragraph with numerical data",
    title: "Title",
    citation: "Citation"
  };

  // Columns that should ALSO show dropdown options (besides text search)
  const DROPDOWN_COLS = new Set([
    H.parameter,
    H.value,
    H.unit,
    H.species,
    H.strain,
    H.source,
    H.status,
    H.mode,
    H.drug
  ]);

  function pmcLink(pmcid) {
    const v = String(pmcid || "").trim();
    if (!v) return "";
    // Accept "PMC10060419" or "10060419"
    const m = v.match(/^PMC?(\d+)$/i);
    if (m) {
      const id = m[1];
      const url = `https://pmc.ncbi.nlm.nih.gov/articles/PMC${id}/`;
      return `<a href="${url}" target="_blank" rel="noopener noreferrer">PMC${id}</a>`;
    }
    return v;
  }

  function titleLink(title, pmcid) {
    const t = String(title || "").trim();
    if (!t) return "";
    const v = String(pmcid || "").trim();
    const m = v.match(/^PMC?(\d+)$/i);
    if (m) {
      const id = m[1];
      const url = `https://pmc.ncbi.nlm.nih.gov/articles/PMC${id}/`;
      const safe = $("<div>").text(t).html();
      return `<a href="${url}" target="_blank" rel="noopener noreferrer">${safe}</a>`;
    }
    return $("<div>").text(t).html();
  }

  function uniqueSorted(arr) {
    return Array.from(
      new Set(arr.map(x => (x ?? "").toString().trim()).filter(Boolean))
    ).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true, sensitivity:"base"}));
  }

  function detailsHtml(row) {
    const citation = (row[H.citation] ?? "").toString().trim();
    const evidence = (row[H.evidence] ?? "").toString().trim();
    const drugDose = (row[H.drugDose] ?? "").toString().trim();

    const safeCitation = $("<div>").text(citation || "—").html();
    const safeEvidence = $("<div>").text(evidence || "—").html();
    const safeDrugDose = $("<div>").text(drugDose || "—").html();

    return `
      <div class="detailsBox">
        <div><span class="k">Citation:</span> ${safeCitation}</div>
        <div style="margin-top:8px;"><span class="k">Evidence (first sentence):</span> ${safeEvidence}</div>
        <div style="margin-top:8px;"><span class="k">Drug amount / concentration (time):</span> ${safeDrugDose}</div>
      </div>
    `;
  }

  Papa.parse("data.csv", {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function (results) {
      let rows = (results.data || []).filter(r =>
        Object.values(r).some(v => (v ?? "").toString().trim() !== "")
      );
      if (!rows.length) return;

      // Fill-down PMC ID if blank
      let lastPMC = "";
      rows.forEach(r => {
        const v = (r[H.pmc] ?? "").toString().trim();
        if (v) lastPMC = v;
        else r[H.pmc] = lastPMC;
      });

      // Ensure all expected headers exist on each row (avoid undefined)
      const allHeaders = Object.values(H);
      rows.forEach(r => {
        allHeaders.forEach(h => { if (!(h in r)) r[h] = ""; });
      });

      // DataTables columns:
      // 1 extra control column for expanding row details (NOT a CSV column)
      // then the 14 CSV columns in order.
      const headers = allHeaders.slice(); // 14 columns

      const columns = [
        {
          title: "", data: null,
          className: "details-control",
          orderable: false,
          searchable: false,
          width: "24px",
          defaultContent: "+",
          render: () => "+"
        },
        ...headers.map(h => ({
          title: h,
          data: h,
          render: function (data, type, row) {
            if (h === H.pmc) return pmcLink(data);
            if (h === H.title) return titleLink(data, row[H.pmc]);
            return (data ?? "").toString();
          }
        }))
      ];

      // Build THEAD: titles + filters
      const $titleRow = $("<tr/>");
      const $filterRow = $("<tr class='filters'/>");

      // Control column header + empty filter cell
      $titleRow.append(`<th></th>`);
      $filterRow.append(`<th></th>`);

      headers.forEach((h, idxZeroBased) => {
        // because we have a leading control column in DataTables, actual DT index is +1
        const dtIdx = idxZeroBased + 1;

        $titleRow.append(`<th>${h}</th>`);

        const hasDropdown = DROPDOWN_COLS.has(h);
        $filterRow.append(`
          <th>
            <div class="colFilter">
              <input type="text" placeholder="Search…" data-col-idx="${dtIdx}">
              ${hasDropdown ? `
                <select data-col-idx="${dtIdx}">
                  <option value="">All options</option>
                </select>
              ` : ``}
            </div>
          </th>
        `);
      });

      $("#tbl thead").empty().append($titleRow).append($filterRow);

      const table = $("#tbl").DataTable({
        data: rows,
        columns: columns,
        responsive: false,
        scrollX: true,
        scrollCollapse: true,
        fixedHeader: true,

        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        dom: "Blfrtip",
        stateSave: true,

        buttons: [
          { extend: "copy",  title: "pd-parameter-database" },
          { extend: "csv",   title: "pd-parameter-database" },
          { extend: "excel", title: "pd-parameter-database" },
          { extend: "print", title: "pd-parameter-database" },
          { extend: "colvis", text: "Columns" },
          { extend: "colvisRestore", text: "Reset columns" }
        ],

        orderCellsTop: true,
        order: [[ 1, "asc" ]] // sort by "PMC ID" (DT index 1)
      });

      // Row count badge
      const updateCount = () => {
        const n = table.rows({ filter: "applied" }).count();
        document.getElementById("rowCount").textContent = `${n} rows`;
      };
      updateCount();
      table.on("draw", updateCount);

      // Populate dropdown options ONLY for selected columns
      headers.forEach((h, idxZeroBased) => {
        const dtIdx = idxZeroBased + 1;
        if (!DROPDOWN_COLS.has(h)) return;

        const col = table.column(dtIdx);
        let values = col.data().toArray();

        // If PMC column ever becomes dropdown (it won't here), we'd want plain values.
        values = uniqueSorted(values);

        const $selects = $(`select[data-col-idx="${dtIdx}"]`);
        $selects.each(function () {
          const $sel = $(this);
          $sel.find("option:not(:first)").remove();
          values.forEach(v => {
            const safe = $("<div>").text(v).html();
            $sel.append(`<option value="${safe}">${safe}</option>`);
          });
        });
      });

      // Delegated handlers so FixedHeader clones also work
      $(document).on("keyup change", 'input[data-col-idx]', function () {
        const idx = Number(this.getAttribute("data-col-idx"));
        const col = table.column(idx);

        // Clear sibling dropdown (if present)
        const $cell = $(this).closest(".colFilter");
        $cell.find('select[data-col-idx]').val("");

        col.search(this.value || "", false, true).draw();
      });

      $(document).on("change", 'select[data-col-idx]', function () {
        const idx = Number(this.getAttribute("data-col-idx"));
        const col = table.column(idx);
        const val = $(this).val();

        // Clear sibling input
        const $cell = $(this).closest(".colFilter");
        $cell.find('input[data-col-idx]').val("");

        col.search(
          val ? `^${$.fn.dataTable.util.escapeRegex(val)}$` : "",
          true,
          false
        ).draw();
      });

      // Global search helpers (focus on requested behaviors)
      const idxTitle = headers.indexOf(H.title) + 1;
      const idxPMC   = headers.indexOf(H.pmc) + 1;
      const idxParam = headers.indexOf(H.parameter) + 1;
      const idxDrug  = headers.indexOf(H.drug) + 1;

      document.getElementById("titleGlobal").addEventListener("input", (e) => {
        table.column(idxTitle).search(e.target.value || "", false, true).draw();
      });
      document.getElementById("pmcGlobal").addEventListener("input", (e) => {
        table.column(idxPMC).search(e.target.value || "", false, true).draw();
      });
      document.getElementById("paramGlobal").addEventListener("input", (e) => {
        table.column(idxParam).search(e.target.value || "", false, true).draw();
      });
      document.getElementById("drugGlobal").addEventListener("input", (e) => {
        table.column(idxDrug).search(e.target.value || "", false, true).draw();
      });

      // Row details: click "+" cell to toggle Citation display
      $("#tbl tbody").on("click", "td.details-control", function () {
        const tr = $(this).closest("tr");
        const row = table.row(tr);

        if (row.child.isShown()) {
          row.child.hide();
          tr.removeClass("shown");
          $(this).text("+");
        } else {
          row.child(detailsHtml(row.data())).show();
          tr.addClass("shown");
          $(this).text("–");
        }
      });

      // Clear all filters
      document.getElementById("clearAll").addEventListener("click", () => {
        table.search("");
        table.columns().search("");

        $("#tbl thead tr.filters input").val("");
        $("#tbl thead tr.filters select").val("");

        document.getElementById("titleGlobal").value = "";
        document.getElementById("pmcGlobal").value = "";
        document.getElementById("paramGlobal").value = "";
        document.getElementById("drugGlobal").value = "";

        // Close any open row details
        table.rows().every(function () {
          if (this.child.isShown()) this.child.hide();
        });
        $("#tbl tbody tr").removeClass("shown");
        $("#tbl tbody td.details-control").text("+");

        table.draw();
      });
    }
  });
})();
</script>

</body>
</html>
